{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h1 class="h1">Occupancy â€” {{ flat.unit }}-{{ flat.floor|stringformat:"02d" }}</h1>
  <div class="sub">Assign or end the current Owner / Lessee and review full history for this flat</div>
</div>

<!-- OWNER PANEL -->
<div class="card">
  <div class="card-head" style="gap:8px;align-items:center">
    <h2 class="card-title">Owner</h2>
    {% if active_owner %}<span class="badge ok">Active</span>{% else %}<span class="badge muted">None</span>{% endif %}
    <span class="badge muted">Current: {% if active_owner %}{{ active_owner.owner.name }}{% else %}None{% endif %}</span>
  </div>

  {% if active_owner %}
    <p><strong>{{ active_owner.owner.name }}</strong></p>
    <p class="muted">From {{ active_owner.start_date }} to {{ active_owner.end_date|default:"present" }}</p>
    <form method="post" action="{% url 'flats:end_owner' flat.pk %}">
      {% csrf_token %}
      <label style="display:inline-flex;gap:6px;align-items:center">
        <input type="checkbox" name="end_parking"> Also end parking now
      </label>
      <button class="btn ghost" type="submit" style="margin-left:8px">End owner now</button>
    </form>
    <hr style="border-color:var(--line);margin:14px 0">
  {% endif %}

  <form method="post" action="{% url 'flats:assign_owner' flat.pk %}" class="form">
    {% csrf_token %}
    <p>
      <label><strong>Owner</strong></label><br>
      <input type="text" id="ownerSearch" class="filter-input"
             placeholder="Search (or browse): flat code (e.g. E-10) or owner name" autocomplete="off">
      <input type="hidden" name="owner" id="id_owner">
      <div id="ownerResults" class="typeahead-panel"></div>
    </p>
    <p><label><strong>Start date</strong></label><br>{{ ownership_form.start_date }}</p>
    <p><label><strong>End date (optional)</strong></label><br>{{ ownership_form.end_date }}</p>

    <!-- Parking-in-same-submit controls -->
    <p style="margin-top:10px">
      <label style="display:inline-flex;gap:6px;align-items:center">
        {{ ownership_form.assign_parking }} Also assign parking
      </label>
    </p>
    <div class="parking-extra" data-parking-extra style="display:none">
      <p><label><strong>Vehicle no</strong></label><br>{{ ownership_form.vehicle_no }}</p>
      <p><label><strong>Parking note</strong></label><br>{{ ownership_form.parking_note }}</p>
    </div>

    <div class="form-actions">
      <button class="btn" type="submit">Assign owner</button>
      <a class="btn ghost" href="{% url 'flats:list' %}">Back to list</a>
    </div>
  </form>
</div>

<!-- LESSEE PANEL -->
<div class="card">
  <div class="card-head" style="gap:8px;align-items:center">
    <h2 class="card-title">Lessee</h2>
    {% if active_lessee %}<span class="badge info">Active</span>{% else %}<span class="badge muted">None</span>{% endif %}
    <span class="badge muted">Current: {% if active_lessee %}{{ active_lessee.lessee.name }}{% else %}None{% endif %}</span>
  </div>

  {% if active_lessee %}
    <p><strong>{{ active_lessee.lessee.name }}</strong></p>
    <p class="muted">From {{ active_lessee.start_date }} to {{ active_lessee.end_date|default:"present" }}</p>
    <form method="post" action="{% url 'flats:end_lessee' flat.pk %}">
      {% csrf_token %}
      <label style="display:inline-flex;gap:6px;align-items:center">
        <input type="checkbox" name="end_parking"> Also end parking now
      </label>
      <button class="btn ghost danger" type="submit" style="margin-left:8px">End lessee now</button>
    </form>
    <hr style="border-color:var(--line);margin:14px 0">
  {% endif %}

  <form method="post" action="{% url 'flats:assign_lessee' flat.pk %}" class="form">
    {% csrf_token %}
    <p>
      <label><strong>Lessee</strong></label><br>
      <input type="text" id="lesseeSearch" class="filter-input"
             placeholder="Search (or browse): flat code (e.g. E-10) or lessee name" autocomplete="off">
      <input type="hidden" name="lessee" id="id_lessee">
      <div id="lesseeResults" class="typeahead-panel"></div>
    </p>
    <p><label><strong>Start date</strong></label><br>{{ tenancy_form.start_date }}</p>
    <p><label><strong>End date (optional)</strong></label><br>{{ tenancy_form.end_date }}</p>

    <!-- Parking-in-same-submit controls -->
    <p style="margin-top:10px">
      <label style="display:inline-flex;gap:6px;align-items:center">
        {{ tenancy_form.assign_parking }} Also assign parking
      </label>
    </p>
    <div class="parking-extra" data-parking-extra style="display:none">
      <p><label><strong>Vehicle no</strong></label><br>{{ tenancy_form.vehicle_no }}</p>
      <p><label><strong>Parking note</strong></label><br>{{ tenancy_form.parking_note }}</p>
    </div>

    <div class="form-actions">
      <button class="btn" type="submit">Assign lessee</button>
      <a class="btn ghost" href="{% url 'flats:list' %}">Back to list</a>
    </div>
  </form>
</div>

<!-- OWNER HISTORY -->
<div class="card">
  <div class="card-head">
    <h2 class="card-title">Owner history ({{ flat.ownerships.all|length }})</h2>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th>Owner</th><th>From</th><th>To</th><th>Status</th><th style="width:260px">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for o in flat.ownerships.all %}
      <tr>
        <td><a href="{% url 'people:owner_edit' o.owner.pk %}">{{ o.owner.name }}</a></td>
        <td>{{ o.start_date }}</td>
        <td>{{ o.end_date|default:"present" }}</td>
        <td>{% if not o.end_date %}<span class="badge ok">Active</span>{% else %}<span class="badge muted">Ended</span>{% endif %}</td>
        <td>
          <a class="btn ghost sm" href="{% url 'people:owner_edit' o.owner.pk %}">Edit</a>
          <a class="btn ghost danger sm" href="{% url 'people:owner_delete' o.owner.pk %}">Delete</a>
          <a class="btn sm" href="{% url 'people:owner_pdf' o.owner.pk %}?dl=1" download>PDF</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="muted">No ownership records yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- LESSEE HISTORY -->
<div class="card">
  <div class="card-head">
    <h2 class="card-title">Lessee history ({{ flat.tenancies.all|length }})</h2>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th>Lessee</th><th>From</th><th>To</th><th>Status</th><th style="width:260px">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for t in flat.tenancies.all %}
      <tr>
        <td><a href="{% url 'people:lessee_edit' t.lessee.pk %}">{{ t.lessee.name }}</a></td>
        <td>{{ t.start_date }}</td>
        <td>{{ t.end_date|default:"present" }}</td>
        <td>{% if not t.end_date %}<span class="badge info">Active</span>{% else %}<span class="badge muted">Ended</span>{% endif %}</td>
        <td>
          <a class="btn ghost sm" href="{% url 'people:lessee_edit' t.lessee.pk %}">Edit</a>
          <a class="btn ghost danger sm" href="{% url 'people:lessee_delete' t.lessee.pk %}">Delete</a>
          <a class="btn sm" href="{% url 'people:lessee_pdf' t.lessee.pk %}?dl=1" download>PDF</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="muted">No tenancy records yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Type-ahead + parking toggles (vanilla JS) -->
<script>
(function () {
  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this, arguments), ms); }; }

  // Type-ahead
  function wireTypeahead(inputId, hiddenId, panelId, endpoint){
    const box   = document.getElementById(inputId);
    const hid   = document.getElementById(hiddenId);
    const panel = document.getElementById(panelId);
    if (!box || !hid || !panel) return;

    function clearPanel(){ panel.innerHTML = ""; panel.style.display='none'; }
    function render(items){
      panel.innerHTML = (items||[]).map(it =>
        `<button type="button" class="btn ghost sm typeahead-item"
                 data-id="${it.id}" data-label="${it.label.replace(/"/g,'&quot;')}">${it.label}</button>`
      ).join("");
      panel.style.display = items && items.length ? 'block' : 'none';
      panel.querySelectorAll('.typeahead-item').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          hid.value = btn.dataset.id;
          box.value = btn.dataset.label;
          clearPanel();
        });
      });
    }

    function fetchAll(){
      fetch(endpoint).then(r=>r.json()).then(d=>render(d.results||[])).catch(()=>clearPanel());
    }
    const fetchFiltered = debounce(()=>{
      const q = (box.value||'').trim();
      if(!q){ fetchAll(); return; }
      fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
        .then(r=>r.json())
        .then(d=>{ if(!d.results || !d.results.length){ fetchAll(); return; } render(d.results); })
        .catch(()=>clearPanel());
    },200);

    box.addEventListener('focus', fetchAll);
    box.addEventListener('input', fetchFiltered);
    box.addEventListener('blur', ()=> setTimeout(clearPanel, 150));
  }

  // Parking extra fields toggle per form
  function bindParkingToggles(){
    document.querySelectorAll('form').forEach(function(f){
      const chk = f.querySelector('input[name="assign_parking"]');
      const extra = f.querySelector('[data-parking-extra]');
      if (!chk || !extra) return;
      const apply = ()=>{ extra.style.display = chk.checked ? 'block' : 'none'; };
      chk.addEventListener('change', apply);
      apply();
    });
  }

  wireTypeahead('ownerSearch',  'id_owner',  'ownerResults',  '/people/api/owners');
  wireTypeahead('lesseeSearch', 'id_lessee', 'lesseeResults', '/people/api/lessees');
  bindParkingToggles();
})();
</script>

{% endblock %}
