{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h1 class="h1">Occupancy — {{ flat.unit }}-{{ flat.floor|stringformat:"02d" }}</h1>
  <div class="sub">Assign or end the current Owner / Lessee and review full history for this flat</div>
</div>

<!-- OWNER PANEL -->
<div class="card">
  <div class="card-head">
    <h2 class="card-title">Owner</h2>
    {% if active_owner %}<span class="badge ok">Active</span>{% else %}<span class="badge muted">None</span>{% endif %}
  </div>

  {% if active_owner %}
    <p><strong>{{ active_owner.owner.name }}</strong></p>
    <p class="muted">From {{ active_owner.start_date }} to {{ active_owner.end_date|default:"present" }}</p>
    <form method="post" action="{% url 'flats:end_owner' flat.pk %}">
      {% csrf_token %}
      <button class="btn ghost" type="submit">End owner now</button>
    </form>
    <hr style="border-color:var(--line);margin:14px 0">
  {% endif %}

  <form method="post" action="{% url 'flats:assign_owner' flat.pk %}" class="form">
    {% csrf_token %}
    <p>
      <label><strong>Owner</strong></label><br>
      <input type="text" id="ownerSearch" class="filter-input"
             placeholder="Search (or browse): flat code or owner name" autocomplete="off">
      <input type="hidden" name="owner" id="id_owner">
      <div id="ownerResults" class="typeahead-panel" hidden></div>
    </p>
    <p><label><strong>Start date</strong></label><br>{{ ownership_form.start_date }}</p>
    <p><label><strong>End date (optional)</strong></label><br>{{ ownership_form.end_date }}</p>
    <div class="form-actions">
      <button class="btn" type="submit">Assign owner</button>
      <a class="btn ghost" href="{% url 'flats:list' %}">Back to list</a>
    </div>
  </form>
</div>

<!-- LESSEE PANEL -->
<div class="card">
  <div class="card-head">
    <h2 class="card-title">Lessee</h2>
    {% if active_lessee %}<span class="badge info">Active</span>{% else %}<span class="badge muted">None</span>{% endif %}
  </div>

  {% if active_lessee %}
    <p><strong>{{ active_lessee.lessee.name }}</strong></p>
    <p class="muted">From {{ active_lessee.start_date }} to {{ active_lessee.end_date|default:"present" }}</p>
    <form method="post" action="{% url 'flats:end_lessee' flat.pk %}">
      {% csrf_token %}
      <button class="btn ghost" type="submit">End lessee now</button>
    </form>
    <hr style="border-color:var(--line);margin:14px 0">
  {% endif %}

  <form method="post" action="{% url 'flats:assign_lessee' flat.pk %}" class="form">
    {% csrf_token %}
    <p>
      <label><strong>Lessee</strong></label><br>
      <input type="text" id="lesseeSearch" class="filter-input"
             placeholder="Search (or browse): flat code or lessee name" autocomplete="off">
      <input type="hidden" name="lessee" id="id_lessee">
      <div id="lesseeResults" class="typeahead-panel" hidden></div>
    </p>
    <p><label><strong>Start date</strong></label><br>{{ tenancy_form.start_date }}</p>
    <p><label><strong>End date (optional)</strong></label><br>{{ tenancy_form.end_date }}</p>
    <div class="form-actions">
      <button class="btn" type="submit">Assign lessee</button>
      <a class="btn ghost" href="{% url 'flats:list' %}">Back to list</a>
    </div>
  </form>
</div>

<!-- (Owner/Lessee history tables — keep your existing blocks here) -->

<script>
(function () {
  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this, arguments), ms); }; }
  function wireTypeahead(inputId, hiddenId, panelId, endpoint){
    var box=document.getElementById(inputId), hid=document.getElementById(hiddenId), panel=document.getElementById(panelId);
    if(!box||!hid||!panel) return;

    function clearPanel(){ panel.innerHTML=""; panel.hidden=true; }
    function render(items){
      panel.innerHTML = items.map(function(it){
        return '<button type="button" class="btn ghost sm typeahead-item" data-id="'+it.id+'" data-label="'+it.label.replace(/"/g,'&quot;')+'">'+it.label+'</button>';
      }).join("");
      panel.hidden = items.length===0;
      panel.querySelectorAll('.typeahead-item').forEach(function(btn){
        btn.addEventListener('click', function(){
          hid.value = this.getAttribute('data-id');
          box.value = this.getAttribute('data-label');
          clearPanel();
        });
      });
    }
    var run = debounce(function(){
      var q = box.value.trim();
      fetch(endpoint + (q ? ("?q=" + encodeURIComponent(q)) : ""))
        .then(function(r){ return r.json(); })
        .then(function(d){ render(d.results || []); })
        .catch(function(){ clearPanel(); });
    }, 200);

    // Show ALL on focus (q empty) + also allow filtering as user types
    box.addEventListener('focus', run);
    box.addEventListener('input', run);
    box.addEventListener('blur', function(){ setTimeout(clearPanel, 150); });
  }
  wireTypeahead('ownerSearch',  'id_owner',  'ownerResults',  '/people/api/owners');
  wireTypeahead('lesseeSearch', 'id_lessee', 'lesseeResults', '/people/api/lessees');
})();
</script>

<style>
.typeahead-panel{margin-top:6px;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1423;max-height:260px;overflow:auto}
.typeahead-item{display:block;width:100%;text-align:left;margin:4px 0}
.filter-input{width:100%;padding:9px;border:1px solid var(--line);border-radius:8px;background:#0b1423;color:var(--ink)}
</style>

{% endblock %}
